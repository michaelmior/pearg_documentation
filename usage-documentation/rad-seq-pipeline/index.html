<!DOCTYPE html>
<html>
  <head>
    <title>PEARG Documentation</title>
    
      <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="revised" content="2022-01-25T16:19:04 AEDT">
<title>Using the RAD-seq Pipeline :: PEARG Documentation</title>
<link rel="shortcut icon" href="/pearg_documentation/images/favicon.png" type="image/x-icon" />
<link href="/pearg_documentation/css/nucleus.css" rel="stylesheet">
<link href="/pearg_documentation/css/font-awesome.min.css" rel="stylesheet">
<link href="/pearg_documentation/css/featherlight.min.css" rel="stylesheet">
<link href="/pearg_documentation/css/auto-complete.css" rel="stylesheet">
<link href="/pearg_documentation/theme-flex/style.css" rel="stylesheet">

	<link href="/pearg_documentation/theme-flex/variant-blue.css" rel="stylesheet">

<link rel="stylesheet" href="/pearg_documentation/css/bootstrap.min.css">
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-79101-13', 'auto');
  ga('send', 'pageview');

</script>

    
  </head>
  <body data-url="/pearg_documentation/usage-documentation/rad-seq-pipeline/">
    
      <header>
  <div class="logo">
    
	
  
    <p>PEARG Documentation</p>

  


  </div>
  <div class="burger"><a href="javascript:void(0);" style="font-size:15px;">&#9776;</a></div>
    <nav class="shortcuts">
            <li class="" role="">
                <a href="https://github.com/pearg/pearg_documentation"  rel="noopener">
                  <i class='fa fa-github'></i> Github repo
                </a>
            </li>
            <li class="" role="">
                <a href="https://gohugo.io/"  rel="noopener">
                  <i class='fa fa-book'></i> Hugo Documentation
                </a>
            </li>
            <li class="" role="">
                <a href="https://github.com/vjeantet/hugo-theme-docdock"  rel="noopener">
                  <i class='fa fa-bookmark'></i> DocDock Theme
                </a>
            </li>
            <li class="" role="">
                <a href="https://blogs.unimelb.edu.au/pearg/"  rel="noopener">
                  <i class='fa fa-globe'></i> PEARG homepage
                </a>
            </li>
    </nav>
</header>
<article>
  <aside>
    <ul class="menu">
          <li data-nav-id="/pearg_documentation/" class="dd-item">
          <a href="/pearg_documentation/">
            <i class="fa fa-fw fa-home"></i>
          </a>
          </li>
    <li data-nav-id="https://pearg.github.io/pearg_documentation/getting-started/" class="dd-item alwaysopen haschildren
        ">
      <div>
      <a href="/pearg_documentation/getting-started/">Getting Started</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/getting-started/hpc-resources/" class="dd-item">
        <div>
          <a href="/pearg_documentation/getting-started/hpc-resources/">
            Compute Resources
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/getting-started/getting-an-account/" class="dd-item">
        <div>
          <a href="/pearg_documentation/getting-started/getting-an-account/">
            Getting an Account
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/getting-started/getting-help/" class="dd-item">
        <div>
          <a href="/pearg_documentation/getting-started/getting-help/">
            Getting Help
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://pearg.github.io/pearg_documentation/best-practices/" class="dd-item alwaysopen haschildren
        ">
      <div>
      <a href="/pearg_documentation/best-practices/">Best Practices</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/best-practices/directory-structure/" class="dd-item">
        <div>
          <a href="/pearg_documentation/best-practices/directory-structure/">
            Directory Structure
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/best-practices/naming-files/" class="dd-item">
        <div>
          <a href="/pearg_documentation/best-practices/naming-files/">
            Naming Files
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/best-practices/backing-up-your-data/" class="dd-item">
        <div>
          <a href="/pearg_documentation/best-practices/backing-up-your-data/">
            Backing Up Your Data
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://pearg.github.io/pearg_documentation/metadata-documentation/" class="dd-item alwaysopen haschildren
        ">
      <div>
      <a href="/pearg_documentation/metadata-documentation/">Metadata Documentation</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/metadata-documentation/metadata-overview/" class="dd-item">
        <div>
          <a href="/pearg_documentation/metadata-documentation/metadata-overview/">
            Metadata Overview
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/metadata-documentation/using-mediaflux/" class="dd-item">
        <div>
          <a href="/pearg_documentation/metadata-documentation/using-mediaflux/">
            Using Mediaflux
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/metadata-documentation/mediaflux-explorer/" class="dd-item">
        <div>
          <a href="/pearg_documentation/metadata-documentation/mediaflux-explorer/">
            Mediaflux Explorer
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/metadata-documentation/sample-map/" class="dd-item">
        <div>
          <a href="/pearg_documentation/metadata-documentation/sample-map/">
            Sample Map
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://pearg.github.io/pearg_documentation/usage-documentation/" class="dd-item alwaysopen haschildren
        ">
      <div>
      <a href="/pearg_documentation/usage-documentation/">Usage Documentation</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/usage-documentation/running-jobs-with-slurm/" class="dd-item">
        <div>
          <a href="/pearg_documentation/usage-documentation/running-jobs-with-slurm/">
            Running Jobs with SLURM
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/usage-documentation/using-vnc/" class="dd-item">
        <div>
          <a href="/pearg_documentation/usage-documentation/using-vnc/">
            Using VNC
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/usage-documentation/installing-software/" class="dd-item">
        <div>
          <a href="/pearg_documentation/usage-documentation/installing-software/">
            Installing Software
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/usage-documentation/stacks-databases/" class="dd-item">
        <div>
          <a href="/pearg_documentation/usage-documentation/stacks-databases/">
            Stacks Databases
          </a>
        </div>
    </li>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/usage-documentation/rad-seq-pipeline/" class="dd-item">
        <div>
          <a href="/pearg_documentation/usage-documentation/rad-seq-pipeline/">
            Using the RAD-seq Pipeline
          </a>
        </div>
    </li>
        </ul>
    </li>
    <li data-nav-id="https://pearg.github.io/pearg_documentation/tutorials/" class="dd-item alwaysopen haschildren
        ">
      <div>
      <a href="/pearg_documentation/tutorials/">Tutorials</a>
            <i class="fa fa-angle-down fa-lg category-icon"></i>
      </div>
        <ul>
      <li data-nav-id="https://pearg.github.io/pearg_documentation/tutorials/intro-rad-seq/" class="dd-item">
        <div>
          <a href="/pearg_documentation/tutorials/intro-rad-seq/">
            Introduction to RAD-Seq
          </a>
        </div>
    </li>
        </ul>
    </li>




    </ul>
    <section>
    </section>
  </aside>
  <section class="page">
    
    <div class="nav-select">
      <center>Navigation : 
        <select onchange="javascript:location.href = this.value;">
          
    <option value="/pearg_documentation/getting-started/" >
   Getting Started</option> 
      <option value="/pearg_documentation/getting-started/hpc-resources/" >- Compute Resources</option>
      <option value="/pearg_documentation/getting-started/getting-an-account/" >- Getting an Account</option>
      <option value="/pearg_documentation/getting-started/getting-help/" >- Getting Help</option>
  
    <option value="/pearg_documentation/best-practices/" >
   Best Practices</option> 
      <option value="/pearg_documentation/best-practices/directory-structure/" >- Directory Structure</option>
      <option value="/pearg_documentation/best-practices/naming-files/" >- Naming Files</option>
      <option value="/pearg_documentation/best-practices/backing-up-your-data/" >- Backing Up Your Data</option>
  
    <option value="/pearg_documentation/metadata-documentation/" >
   Metadata Documentation</option> 
      <option value="/pearg_documentation/metadata-documentation/metadata-overview/" >- Metadata Overview</option>
      <option value="/pearg_documentation/metadata-documentation/using-mediaflux/" >- Using Mediaflux</option>
      <option value="/pearg_documentation/metadata-documentation/mediaflux-explorer/" >- Mediaflux Explorer</option>
      <option value="/pearg_documentation/metadata-documentation/sample-map/" >- Sample Map</option>
  
    <option value="/pearg_documentation/usage-documentation/" >
   Usage Documentation</option> 
      <option value="/pearg_documentation/usage-documentation/running-jobs-with-slurm/" >- Running Jobs with SLURM</option>
      <option value="/pearg_documentation/usage-documentation/using-vnc/" >- Using VNC</option>
      <option value="/pearg_documentation/usage-documentation/installing-software/" >- Installing Software</option>
      <option value="/pearg_documentation/usage-documentation/stacks-databases/" >- Stacks Databases</option>
      <option value="/pearg_documentation/usage-documentation/rad-seq-pipeline/"  selected>- Using the RAD-seq Pipeline</option>
  
    <option value="/pearg_documentation/tutorials/" >
   Tutorials</option> 
      <option value="/pearg_documentation/tutorials/intro-rad-seq/" >- Introduction to RAD-Seq</option>
  



        </select>
      </center>
    </div>
      <div>
        <div class="searchbox">
          <input data-search-input id="search-by" type="text" placeholder="Search...">
        </div>
      </div>
    

    <h1>Using the RAD-seq Pipeline</h1>
    
    
    
    <p>If you&rsquo;re using the <code>mozzie</code> or <code>rescue</code> server and want to use Stacks &gt;= 2.0
to perform your RAD-seq data processing and analysis, then you have the
option of using the RAD-seq pipeline:
<a href="https://github.com/pearg/radpipe">radpipe</a>.</p>
<p>To use the pipeline, it is highly recommended you have some knowledge on how to
use <a href="https://en.wikipedia.org/wiki/GNU_Screen">Screen</a> or another
terminal multiplexer such as <a href="https://en.wikipedia.org/wiki/Tmux">Tmux</a>. This
is because the pipeline can run for hours or days and a terminal multiplexer
will allow you to detach the session so it can continue running when you
disconnect from the server. These instructions assume you are familiar with
Screen.</p>
<p>If you want to run <code>radpipe</code> on another system such as your own virtual machine
or local computer, you&rsquo;ll need to install it and the dependencies described
<a href="https://github.com/pearg/radpipe/blob/master/README.md">here</a>.</p>

<div class="notices info" ><p><p>Note that radpipe does not support the Stacks de-novo assembly workflow (yet).
To use the pipeline, you will need a reference genome to align your sequence
data to.</p>
</p></div>

<hr>
<h2 id="project-setup">Project setup</h2>
<p>Before you begin any analysis you need to create your project directory to
store your analysis.</p>
<p>Your project directory should follow our
<a href="/pearg_documentation/best-practices/directory-structure/">best practices guidelines</a>.</p>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># I like to store my projects in a directory named &#39;projects&#39; located in my home directory</span>
cd ~/projects

<span style="color:#75715e"># Give your project a name that makes sense</span>
mkdir super_rad_project <span style="color:#f92672">&amp;&amp;</span> cd super_rad_project

<span style="color:#75715e"># Create directories for the data, results, and reference files</span>
mkdir data results reference
</code></pre></div><p>If you don&rsquo;t have your reference genome for your organism on the server yet,
download it to the <code>reference/</code> directory. If the reference genome is already
on the server, I recommend you move or or symlink the file to the reference
directory.</p>
<p>Download your sequencing FASTQ files and place them in your <code>data/</code>
directory. Make sure your <code>data/</code> directory has a separate directory for
each sequencing run or library. Each directory must contain two files from
Illumina sequencing, a FASTQ file containing forward reads (R1) and a FASTQ
file containing reverse reads (R2).</p>
<p>Each library should have a barcodes file containing the barcode pair and the
sample name separated by tabs. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">ACGTCA	CATGAC	A110
GTACTG	CATGAC	E002
CTAGTC	CATGAC	X433
AGCTGA	CATGAC	A8814
</code></pre></div>
<div class="notices note" ><p><p>If using the mozzie or rescue servers and symlinking data make sure your paths
begin with <code>/mnt/galaxy/home/my_username/...</code> and not <code>/home/my_username/...</code>.
This is because jobs running on worker nodes need the <code>/mnt/</code> path to find the
files as the user directory symlinks in <code>/home/</code> don&rsquo;t exist on the worker
nodes.</p>
</p></div>

<hr>
<h2 id="pipeline-stages">Pipeline stages</h2>
<img src=https://swift.rc.nectar.org.au:8888/v1/AUTH_0edd079661d54bc0a0e4fde3b4892362/images/radpipe_flowchart.png width="500px">
<p>The pipeline is composed of a number of stages.</p>
<ul>
<li><strong><code>fastqc</code></strong>: Runs FastQC on raw sequencing files and outputs to <code>results/qc/fastqc/</code>.</li>
<li><strong><code>multiqc_fastqc</code></strong>: Runs MultiQC on FastQC outputs and outputs to <code>results/qc/</code>.</li>
<li><strong><code>process_radtags</code></strong>: Runs Stacks process_radtags to demux samples and outputs to <code>results/sample_radtags/</code>.</li>
<li><strong><code>build_index</code></strong>: Builds index for the reference FASTA file for either bwa or bowtie and stores indices in <code>results/ref/</code>.</li>
<li><strong><code>alignment</code></strong>: Aligns FASTQ files with either bwa or bowtie and outputs BAMs to <code>results/alignments/</code>.</li>
<li><strong><code>sort_bam</code></strong>: Sorts BAM files by coordinate and generates indices. Outputs to <code>results/alignments/</code>.</li>
<li><strong><code>filter_bam</code></strong>: Optional step to filter BAM files using Samtools view. Outputs to <code>results/alignments/</code>.</li>
<li><strong><code>flagstat</code></strong>: Runs Samtools flagstat on the final BAM files and outputs to <code>results/qc/flagstat/</code>.</li>
<li><strong><code>multiqc_flagstat</code></strong>: Runs MultiQC on the flagstat outputs and outputs to <code>results/qc/</code>.</li>
<li><strong><code>gstacks</code></strong>: Runs Stacks gstacks on sorted BAMs and outputs to <code>results/gstacks/</code>.</li>
<li><strong><code>populations</code></strong>: Runs Stacks populations and outputs to <code>results/populations/</code>.</li>
</ul>
<p>Ruffus (the framework the pipeline uses) works by requiring you to specify
a target task. The pipeline will then work out which tasks the target task
depends on, and run them automatically.</p>
<hr>
<h2 id="create-a-pipeline-config-file">Create a pipeline config file</h2>
<p><code>radpipe</code> reads a configuration file to define how the pipeline stages will
be run. This config file is written in YAML.</p>
<p>Copy the below block, and paste the contents in a file named <code>pipeline.config</code>
in your project directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">#---------------------------------
# CONFIG
#---------------------------------

pipeline_id: radpipe

# The directory the pipeline will write files.
results_dir: results/

# The reference genome in FASTA format.
reference_genome: ref/mppdraft3.fa

# Sequencing data
# Each sequencing run / library should be in its own directory. In each
# directory, there should be two Illumina sequncing read files in *fastq.gz
# format (R1 and R2) and a text file containing barcodes in the format that
# process_radtags accepts. FASTQ filenames should be unique.
# Note that the directory name will be used as the read group ID for when
# performing alignment.
libraries:
    lib_01:
        lib_dir: data/lib_01
        r1: BparvusLib1_S1_R1_001.fastq.gz
        r2: BparvusLib1_S1_R2_001.fastq.gz
        barcodes: lib1_barcode.txt
    lib_02:
        lib_dir: data/lib_02
        r1: BparvusLib2_S2_R1_001.fastq.gz
        r2: BparvusLib2_S2_R2_001.fastq.gz
        barcodes: lib2_barcode.txt

#---------------------------------
# PROCESS RADTAG OPTIONS
#---------------------------------

# The two restriction enzymes used.
renz_1: sphI
renz_2: mluCI

# Additional process_radtag options
# http://catchenlab.life.illinois.edu/stacks/comp/process_radtags.php
# Add PCR adapter options if necessary:
# --adapter_1 AGATCGGAAGAGCGGTTCAGCAGGAATGCCGAGACCGATCTCGTATGCCGTCTTCTGCTTG
# --adapter_2 AGATCGGAAGAGCGTCGTGTAGGGAAAGAGTGTAGATCTCGGTGGTCGCCGTATCATT
process_radtags_options: &#34;-t 60 -c -q -r -s 10&#34;

#---------------------------------
# ALIGNMENT OPTIONS
#---------------------------------

# Which program to use for alignment. Choose from [bowtie, bwa mem]
alignment_method: bwa mem

# Additional alignment options
# bwa mem: http://bio-bwa.sourceforge.net/bwa.shtml
alignment_options: &#34;-a&#34;
# bowtie: http://bowtie-bio.sourceforge.net/manual.shtml
# alignment_options: &#34;-v 3 --tryhard --best&#34;

#---------------------------------
# BAM FILTERING OPTIONS
#---------------------------------

# Samtools view filtering options. Comment out to skip bam filtering step.
# samtools_view_options: &#34;-f 3 -q 30&#34;

#---------------------------------
# STACKS GSTACKS OPTIONS
#---------------------------------

# Extra options for gstacks
# http://catchenlab.life.illinois.edu/stacks/comp/gstacks.php
gstacks_options: &#34;&#34;

#---------------------------------
# STACKS POPULATIONS OPTIONS
#---------------------------------

# Analysis ID
# If you plan to run multiple populations runs with different popmap files, give
# each run a different name, which will create new directories in the results
# directory instead of overwriting them
analysis_id: analysis_v1

# Custom popmap file (optional)
# If this is left blank, the pipeline will create a popmap file with all samples
# in the same population group. Note that this is for stacks populations
# only (gstacks will use all available samples)
# popmap_file: test_popmap.txt

# Values of r for which Stacks populations will run. A new directory will
# be created for each run
populations_r:
  - 0.5
  - 0.75
  - 0.8

# Extra options for populations. Note that the --vcf option will be
# automatically included when running the pipeline.
# http://catchenlab.life.illinois.edu/stacks/comp/populations.php
populations_options: &#34;--min_maf 0.05 --write_random_snp --hwe --fstats --genepop&#34;


#---------------------------------
# SLURM PIPELINE CONFIG
#---------------------------------

# Default settings for the pipeline stages.
# These can be overridden in the stage settings below.

defaults:
    # Number of CPU cores to use for the task
    cores: 1
    # Maximum memory in gigabytes for a cluster job
    mem: 4
    # VLSCI account for quota
    account: VR0002
    queue: main
    # Maximum allowed running time on the cluster in Hours:Minutes
    walltime: &#39;1:00&#39;
    # Load modules for running a command on the cluster.
    modules:
    # Run on the local machine (where the pipeline is run)
    # instead of on the cluster. False means run on the cluster.
    local: False

# Stage-specific settings. These override the defaults above.

stages:
    fastqc:
        walltime: &#39;2:00&#39;
    multiqc:
        walltime: &#39;1:00&#39;
    process_radtags:
        walltime: &#39;8:00&#39;
        mem: 4
    build_index:
        walltime: &#39;8:00&#39;
        mem: 16
    alignment:
        walltime: &#39;8:00&#39;
        cores: 2
        mem: 8
    sort_bam:
        walltime: &#39;4:00&#39;
        mem: 4
    filter_bam:
        walltime: &#39;1:00&#39;
    flagstat:
        walltime: &#39;1:00&#39;
    gstacks:
        walltime: &#39;24:00&#39;
        cores: 8
        mem: 32
    populations:
        walltime: &#39;24:00&#39;
        cores: 4
        mem: 8
</code></pre></div><p>Carefully read through the config file and edit the options to fit with
your analysis.</p>
<ul>
<li>Edit the <code>libraries</code> dictionary to contain your library directories and
filenames.</li>
<li>Edit the Stacks process radtags options if necessary.</li>
<li>Edit the alignment options if necessary. Note that the pipeline supports
both BWA mem and Bowtie using the <code>alignment_method</code> option.</li>
<li>Edit the BAM filtering options if necessary. If <code>samtools_view_options</code> is
commented out, filtering will be skipped.</li>
<li>Edit the Stacks populations options if necessary. If you have a popmap file,
uncomment the <code>popmap_file</code> option and provide the path to your file.</li>
<li>The remaining SLURM pipeline options should be left as is unless your jobs
are running out of walltime or memory.</li>
</ul>
<hr>
<h2 id="executing-the-pipeline">Executing the pipeline</h2>
<p>If you&rsquo;re using the mozzie or rescue servers, radpipe is already installed.</p>
<p>Before you begin, start up a screen session. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Create and attach a screen session named &#39;pipeline&#39;</span>
screen -S pipeline
</code></pre></div><p>radpipe is installed inside a Python virtual environment. You can activate
the virtual environment with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">source /mnt/galaxy/gvl/software/radpipe/bin/activate
</code></pre></div>
<div class="notices note" ><p><p><strong>What is a virtual environment?</strong><br>
On the server, radpipe is installed inside a Python virtual environment.<br>
TODO: briefly explain virtual environments</p>
</p></div>

<p>First, see if you can run <code>radpipe</code> and look at the usage information the
program has with the <code>-h</code> option.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">radpipe -h
</code></pre></div><p>The pipeline runs by specifying a target task. All stages that are required
for that task to run are executed. For example, running radpipe with
<code>--target_task=alignment</code>, the pipeline will run the <strong>process_radtags</strong>,
<strong>build_index</strong>, and <strong>alignment</strong> steps. If you want to know which tasks will
be run when you specify a particular target_task, you can refer to the
<a href="#pipeline-stages">above flowchart</a>, then look for your task and follow
all the dependencies upward to see what will be run.</p>
<p>Try using the <code>-n</code> (or <code>--just_print</code>) option to perform a dry run of the
pipeline.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">radpipe <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --config pipeline.config <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --verbose <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target_tasks alignment <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    -n
</code></pre></div><p>Something like the following should be printed on to the screen:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">________________________________________
Tasks which will be run:

Task = &#39;radpipe::reference_genome&#39;
Task = &#39;radpipe::process_radtags&#39;
Task = &#39;radpipe::bwa_index&#39;
Task = &#39;radpipe::bwa_mem&#39;
________________________________________

</code></pre></div><p>Note that since &ldquo;bwa mem&rdquo; is specified as the alignment method in the
configuration file, the build_index task is named bwa_index and the alignment
task is named bwa_mem.</p>
<p>I recommend always running radpipe with the <code>-n</code> option to print what tasks
will be run before running jobs for real.</p>

<div class="notices note" ><p><p><strong>Verbosity level:</strong><br>
The <code>--verbose</code> option allows you to set the verbosity (how much information
the program prints out to the screen) of the pipeline. It&rsquo;s useful to increase
the verbosity level if you&rsquo;re troubleshooting a problem. Generally, I recommend
<code>--verbose 3</code> as a good level of verbosity for radpipe.</p>
</p></div>

<p>You can also generate a flowchart image with the <code>--flowchart</code> option.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">radpipe <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --config pipeline.config <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target_tasks populations,multiqc_fastqc,multiqc_flagstat <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --flowchart_format png <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --flowchart radpipe.png
</code></pre></div><hr>
<h2 id="running-the-pipeline">Running the pipeline</h2>
<p>It is recommended to run <strong>fastqc</strong> and <strong>multiqc_fastqc</strong> before you begin
processing your data. After MultiQC finishes, view the <code>multiqc_report.html</code>
file by transferring the html file to your computer and opening it in your
web browser. Alternatively you could also move the html file to the your
<code>public_html</code> directory and view the file remotely.</p>
<p>Make sure you&rsquo;re inside a screen session before running the pipeline.
You can run the pipeline to <code>multiqc_fastqc</code> with the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">radpipe <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --config pipeline.config <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --verbose <span style="color:#ae81ff">3</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --log_file radpipe.log <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --target_tasks multiqc_fastqc <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --jobs <span style="color:#ae81ff">8</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --use_threads
</code></pre></div><p>The <code>--jobs</code> option allows the pipeline to submit multiple jobs to the
SLURM queue. This will result in a maximum of 8 jobs in your queue.
If there are more than 8 jobs in total, the jobs will be submitted one
at a time as jobs get completed.</p>

<div class="notices note" ><p><p><strong>How many jobs should I run at a time?</strong><br>
If you&rsquo;re the only person running jobs on the server, you can use as many
CPUs as there are available. SLURM will handle the resources automatically,
so jobs will wait in the queue until there are enough resouces available for
that particular job to run. However, if you&rsquo;re sharing the server with other
people, please limit the number of jobs you&rsquo;re submittiing as the SLURM
scheduling configuration is set to run jobs as First In, First Out.</p>
</p></div>

<p>Once your jobs are running, in another terminal session or screen session,
try checking the SLURM queue (and if you need to refresh your memory on SLURM
commands, you can do so
<a href="/pearg_documentation/usage-documentation/running-jobs-with-slurm/">here</a>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">squeue
</code></pre></div><p>You should see a list of your jobs running and which node they&rsquo;re running on.
e.g.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-txt" data-lang="txt">     JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
     1843      main radpipe_     jess  R       3:30      1 master
     1844      main radpipe_     jess  R       2:39      1 w1
</code></pre></div><p>The job names in the queue are too long, so they appear cut off. You can
use squeue&rsquo;s <code>-o</code> option to specify the output format and make the job
name column wider.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">squeue -o <span style="color:#e6db74">&#34;%.10i %.22j %.8u %.8T %.10M %.9l %.6D %R&#34;</span>
</code></pre></div><p>Using the <code>--log_file</code> option will create a log file called <code>radpipe.log</code>
which will keep track of what commands you ran.</p>
<p>As an addition layer of logging, Slurm job scripts are written in the newly
created <code>jobscripts/</code> directory. If a job fails, and you&rsquo;re trying to
troubleshoot why, you can check the stderr files in this directory.</p>
<p>You can also increase the verbosity by supplying a number after the <code>--verbose</code>
option, e.g. <code>--verbose 3</code>.</p>
<p>If an individual task of the pipeline fails (e.g. due to running
out of memory), the pipeline will stop running after the jobs in the SLURM
queue are finished. When you run radpipe again, the pipeline will only
run the jobs that need running (i.e. it won&rsquo;t re-run the previously completed
steps). However, if you update an earlier stage in the pipeline (e.g. changing
the reference genome file), all the downstream tasks will be indentified as
being out-of-date, and the pipeline will attempt to run these tasks again the
next time you specify a target task that depends on the out-of-date task.</p>
<hr>
<h2 id="how-to-kill-a-running-pipeline">How to kill a running pipeline</h2>
<p>If you want to kill a running pipeline that is running on the cluster and
<code>^C</code> isn&rsquo;t killing the pipeline process, you will need to cancel all individual
pipeline jobs in the system. With SLURM, you can cancel your jobs with
<code>scancel &lt;job_id&gt;</code>. If all your jobs are from radpipe, you can cancel all jobs
submitted with <code>scancel --user=&lt;your_username&gt;</code>.</p>


    
    
        <div class="chevrons">
    <div id="navigation">
<a class="nav nav-prev" href="/pearg_documentation/usage-documentation/stacks-databases/" title="Stacks Databases"> <i class="fa fa-chevron-left"></i><label>Stacks Databases</label></a>
    <a class="nav nav-next" href="/pearg_documentation/tutorials/" title="Tutorials" style="margin-right: 0px;"><label>Tutorials</label><i class="fa fa-chevron-right"></i></a></div>
  </div>

  </section>
</article>

<footer>

<div class="footline">
    

    

    
    <div class="date">
        <i class='fa fa-calendar'></i> Last update on 11/08/2017
    </div>
    

    
    <div class="github-link">
      <a href="https://github.com/pearg/pearg_documentation/edit/master/content/usage-documentation/rad-seq-pipeline.md" target="blank"><i class="fa fa-code-fork"></i>
        Improve this page</a>
    </div>
    
  </div>


	<div>


  
    Create a content/_footer.md file to customize the footer content
  



	</div>
</footer>

<script src="/pearg_documentation/js/jquery-2.x.min.js"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/pearg.github.io\/pearg_documentation\/";
    
</script>
<script src="/pearg_documentation/js/clipboard.min.js"></script>
<script src="/pearg_documentation/js/featherlight.min.js"></script>

<script type="text/javascript" src="/pearg_documentation/js/lunr.min.js"></script>
<script type="text/javascript" src="/pearg_documentation/js/auto-complete.js"></script>
<script type="text/javascript" src="/pearg_documentation/js/search.js"></script>
<script src="/pearg_documentation/theme-flex/script.js"></script>




<script src="https://pearg.github.io/pearg_documentation/js/scripts.min.js"></script>
    

    
    

    
  </body>
</html>